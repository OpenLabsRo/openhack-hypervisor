# /etc/nginx/conf.d/app.conf
# Blue = primary (8080), Green = standby (8081).
# When Blue restarts (or /hypervisor/meta/ping returns 503 during drain), traffic falls to Green.
# When Blue is healthy again, traffic snaps back without an nginx reload.

upstream blue {
    server 127.0.0.1:8080 max_fails=1 fail_timeout=2s max_conns=512;
    keepalive 64;
}
upstream green {
    server 127.0.0.1:8081 max_fails=1 fail_timeout=2s max_conns=512;
    keepalive 64;
}

# Upgrade header helper for WebSockets
map $http_upgrade $upgrade_hdr {
    default upgrade;
    ""      close;
}

server {
    listen 80 reuseport;

    # Fail fast so we flip to green quickly if blue is down/draining
    proxy_connect_timeout 500ms;
    proxy_read_timeout    60s;   # long enough for idle WS pings
    proxy_send_timeout    30s;
    proxy_http_version    1.1;

    # Retry only on true failures/timeouts/5xx
    proxy_next_upstream error timeout http_502 http_503 http_504;
    proxy_next_upstream_timeout 2s;
    proxy_next_upstream_tries 2;

    # Common headers
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";  # keepalive for HTTP
    proxy_buffering off;             # good default for APIs/WS; enable per-route if needed

    # --- Primary route: try BLUE, on 502/503/504 jump to GREEN
    location / {
        proxy_pass http://blue;
        error_page 502 503 504 = @green;
    }

    location @green {
        proxy_pass http://green;
    }

    # --- WebSocket endpoint(s) (example path). Use same fallback behavior.
    # Duplicate/adjust for your actual WS routes.
    location /ws/ {
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $upgrade_hdr;
        proxy_pass http://blue;
        error_page 502 503 504 = @green_ws;
    }

    location @green_ws {
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $upgrade_hdr;
        proxy_pass http://green;
    }

    # --- Health: Blue-first; if Blue is draining (503) or down, route to Green.
    location = /hypervisor/meta/ping {
        proxy_buffering off;
        proxy_pass http://blue;
        error_page 502 503 504 = @green_health;
    }

    location @green_health {
        proxy_buffering off;
        proxy_pass http://green;
    }
}
